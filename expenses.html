<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Expenses - Petty Cash</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Tudawe Trading Co(Pvt)Ltd</h1>
                    <p class="text-sm text-blue-200">Daily Expense Sheet</p>
                </div>
                <a href="index.html" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded font-semibold">‚Üê Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Add Expense Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Record Daily Expense</h2>
            <div class="mb-4">
                <input type="text" id="expenseSearch" placeholder="Search expenses..." class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
            </div>
            
            <form id="expenseForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                        <input type="date" id="expenseDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Category *</label>
                        <select id="category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Select Category</option>
                            <option value="Office Supplies">Office Supplies</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Meals & Entertainment">Meals & Entertainment</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description *</label>
                        <input type="text" id="description" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="What was purchased?">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Amount (Rs) *</label>
                        <input type="number" id="amount" required step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="0.00">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">From</label>
                        <input type="text" id="vendor" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Vendor/Store name">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Receipt #</label>
                        <input type="text" id="receipt" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Invoice/Receipt number">
                    </div>
                </div>

                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">+ Add Expense</button>
            </form>
        </div>

        <!-- Bulk Import Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 border-2 border-green-300">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">üì• Bulk Import Expenses</h2>
            <p class="text-gray-600 mb-4">Import multiple expenses at once. Format: Date | Vendor | Description | Category | Amount (comma-separated per line)</p>
            
            <form id="bulkImportForm" class="space-y-4">
                <textarea id="bulkData" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm" placeholder="20/08/2024,show room old deposit,show room old deposit 06/07/2024 ( note 1),Other,61688.00&#10;21/08/2024,Services,Services old deposit 06/07/2024,Other,15146.75&#10;17/02/2026,RASU,MEAL EXPENSES,Meals & Entertainment,550.00"></textarea>
                <div class="bg-green-50 p-3 rounded text-sm text-gray-700">
                    <p><strong>Format:</strong> Date,Vendor Name,Description,Category,Amount</p>
                    <p><strong>Example:</strong> 20/08/2024,show room old deposit,show room old deposit 06/07/2024,Other,61688.00</p>
                    <p><strong>Categories:</strong> Office Supplies, Transportation, Meals & Entertainment, Utilities, Maintenance, Marketing, Other</p>
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">‚Üë Import Multiple Expenses</button>
            </form>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Filter by Category</label>
                    <select id="filterCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Categories</option>
                        <option value="Office Supplies">Office Supplies</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Meals & Entertainment">Meals & Entertainment</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <label class="flex items-center gap-2 mb-0">
                        <input type="checkbox" id="showReimbursedToggle" class="w-4 h-4 rounded border-gray-300">
                        <span class="text-sm font-semibold text-gray-700">Show Reimbursed Only</span>
                    </label>
                </div>
                <div class="flex items-end">
                    <button onclick="printReport()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">üñ®Ô∏è Print Report</button>
                </div>
            </div>
        </div>

        <!-- Expenses List -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800" id="expensesListTitle">Expense List</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-green-100 border-b-2 border-green-600">
                        <tr>
                            <th class="px-4 py-3 text-left">Date</th>
                            <th class="px-4 py-3 text-left">Category</th>
                            <th class="px-4 py-3 text-left">Description</th>
                            <th class="px-4 py-3 text-left">Vendor</th>
                            <th class="px-4 py-3 text-left">Receipt #</th>
                            <th class="px-4 py-3 text-right">Amount</th>
                            <th class="px-4 py-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expensesList">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">No expenses recorded yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-green-50 border-l-4 border-green-600 rounded">
                    <p class="text-gray-700"><span class="font-bold">Total Expenses:</span></p>
                    <p id="totalExpenses" class="text-2xl font-bold text-green-600">Rs 0.00</p>
                </div>
                <div class="p-4 bg-blue-50 border-l-4 border-blue-600 rounded">
                    <p class="text-gray-700"><span class="font-bold">Highest Category:</span></p>
                    <p id="highestCategory" class="text-lg font-bold text-blue-600">-</p>
                </div>
                <div class="p-4 bg-purple-50 border-l-4 border-purple-600 rounded">
                    <p class="text-gray-700"><span class="font-bold">No. of Expenses:</span></p>
                    <p id="expenseCount" class="text-2xl font-bold text-purple-600">0</p>
                </div>
            </div>

            <!-- Balance Update Alert -->
            <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-600 rounded hidden" id="balanceAlert">
                <p class="text-yellow-900"><strong>‚ö° Balance Updated!</strong> <span id="balanceUpdateText"></span></p>
            </div>
        </div>
    </div>

    <script>
        // Auth check
        function checkAuth() {
            const user = localStorage.getItem('_pettycash_currentUser');
            if (!user) {
                window.location.href = 'login.html';
            }
        }

        function getStorageKey(key) {
            const user = localStorage.getItem('_pettycash_currentUser');
            return user ? `${user}_${key}` : key;
        }

        checkAuth();

        function formatCurrency(amount) {
            return 'Rs ' + parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function initializeForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
        }

        function displayExpenses(filterCategory = '', showReimbursed = false, searchTerm = '') {
            let expenses = JSON.parse(localStorage.getItem(getStorageKey('expenses')) || '[]');
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                expenses = expenses.filter(exp => exp.description.toLowerCase().includes(term) || (exp.vendor||'').toLowerCase().includes(term));
            }
            
            // Filter by reimbursement status
            expenses = expenses.filter(exp => showReimbursed ? exp.reimbursed : !exp.reimbursed);
            
            if (filterCategory) {
                expenses = expenses.filter(exp => exp.category === filterCategory);
            }

            const tbody = document.getElementById('expensesList');

            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No expenses recorded yet</td></tr>';
                document.getElementById('expensesListTitle').textContent = showReimbursed ? 'Reimbursed Expenses' : 'Expense List';
                updateSummary([]);
                return;
            }

            let total = 0;
            tbody.innerHTML = expenses.map((exp, index) => {
                total += parseFloat(exp.amount || 0);
                return `
                    <tr class="border-b hover:bg-green-50">
                        <td class="px-4 py-3">${exp.date}</td>
                        <td class="px-4 py-3"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">${exp.category}</span></td>
                        <td class="px-4 py-3 font-semibold">${exp.description}</td>
                        <td class="px-4 py-3 text-gray-600">${exp.vendor || '-'}</td>
                        <td class="px-4 py-3 text-gray-600">${exp.receipt || '-'}</td>
                        <td class="px-4 py-3 text-right font-bold">${formatCurrency(exp.amount)}</td>
                        <td class="px-4 py-3 text-center">
                            ${showReimbursed ? `<button onclick="undoReimbursement(${index})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs mr-1">Undo</button>` : `<button onclick="markAsReimbursed(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs mr-1">Reimbursed</button>`}
                            <button onclick="deleteExpense(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('expensesListTitle').textContent = showReimbursed ? 'Reimbursed Expenses' : 'Expense List';
            document.getElementById('totalExpenses').textContent = formatCurrency(total);
            updateSummary(expenses);
        }

        function updateSummary(expenses) {
            document.getElementById('expenseCount').textContent = expenses.length;

            if (expenses.length === 0) {
                document.getElementById('highestCategory').textContent = '-';
                return;
            }

            const categories = {};
            expenses.forEach(exp => {
                categories[exp.category] = (categories[exp.category] || 0) + parseFloat(exp.amount);
            });

            const highest = Object.entries(categories).reduce((max, [cat, amt]) => amt > max.amount ? {cat, amount: amt} : max, {cat: '-', amount: 0});
            document.getElementById('highestCategory').textContent = `${highest.cat} (${formatCurrency(highest.amount)})`;
        }

        function markAsReimbursed(index) {
            const allExpenses = JSON.parse(localStorage.getItem(getStorageKey('expenses')) || '[]');
            const activeExpenses = allExpenses.filter(exp => !exp.reimbursed);
            if (!activeExpenses[index]) return;
            
            const actualIndex = allExpenses.findIndex(e => e === activeExpenses[index]);
            allExpenses[actualIndex].reimbursed = true;
            allExpenses[actualIndex].reimbursedDate = new Date().toISOString().split('T')[0];
            localStorage.setItem(getStorageKey('expenses'), JSON.stringify(allExpenses));

            // recalc balance change
            const FLOAT_AMOUNT = 250000;
            const ious = JSON.parse(localStorage.getItem(getStorageKey('ious')) || '[]');
            const invoices = JSON.parse(localStorage.getItem(getStorageKey('invoices')) || '[]');
            const prevExpenses = allExpenses.filter(exp => !exp.reimbursed || exp === activeExpenses[index]);
            const oldBalance = FLOAT_AMOUNT - (ious.reduce((sum, iou) => sum + parseFloat(iou.amount || 0), 0) + prevExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0) - invoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0));
            const newExpenses = allExpenses.filter(exp => !exp.reimbursed);
            const newBalance = FLOAT_AMOUNT - (ious.reduce((sum, iou) => sum + parseFloat(iou.amount || 0), 0) + newExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0) - invoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0));
            const diff = newBalance - oldBalance;

            displayExpenses(document.getElementById('filterCategory').value, false);
            alert(`Expense marked as Reimbursed. Balance ${diff >= 0 ? 'increased' : 'decreased'} by Rs ${Math.abs(diff).toFixed(2)}.`);
        }

        function undoReimbursement(index) {
            const allExpenses = JSON.parse(localStorage.getItem(getStorageKey('expenses')) || '[]');
            const reimbursedExpenses = allExpenses.filter(exp => exp.reimbursed);
            if (!reimbursedExpenses[index]) return;
            
            const actualIndex = allExpenses.findIndex(e => e === reimbursedExpenses[index]);
            allExpenses[actualIndex].reimbursed = false;
            delete allExpenses[actualIndex].reimbursedDate;
            localStorage.setItem(getStorageKey('expenses'), JSON.stringify(allExpenses));

            // recalc balance change
            const FLOAT_AMOUNT = 250000;
            const ious = JSON.parse(localStorage.getItem(getStorageKey('ious')) || '[]');
            const invoices = JSON.parse(localStorage.getItem(getStorageKey('invoices')) || '[]');
            const prevExpenses = allExpenses.filter(exp => !exp.reimbursed);
            // before undo, this expense was excluded; include it now
            const oldBalance = FLOAT_AMOUNT - (ious.reduce((sum, iou) => sum + parseFloat(iou.amount || 0), 0) + prevExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0) - invoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0));
            const newExpenses = allExpenses.filter(exp => !exp.reimbursed || exp === reimbursedExpenses[index]);
            const newBalance = FLOAT_AMOUNT - (ious.reduce((sum, iou) => sum + parseFloat(iou.amount || 0), 0) + newExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0) - invoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0));
            const diff = newBalance - oldBalance;

            displayExpenses(document.getElementById('filterCategory').value, true);
            alert(`Reimbursement undone. Balance ${diff >= 0 ? 'increased' : 'decreased'} by Rs ${Math.abs(diff).toFixed(2)}.`);
        }

        function deleteExpense(index) {
            if (confirm('Are you sure you want to delete this expense?')) {
                let expenses = JSON.parse(localStorage.getItem(getStorageKey('expenses')) || '[]');
                const showReimbursed = document.getElementById('showReimbursedToggle')?.checked || false;
                const filtered = showReimbursed ? expenses.filter(exp => exp.reimbursed) : expenses.filter(exp => !exp.reimbursed);
                const actualIndex = expenses.indexOf(filtered[index]);
                expenses.splice(actualIndex, 1);
                localStorage.setItem(getStorageKey('expenses'), JSON.stringify(expenses));
                displayExpenses(document.getElementById('filterCategory').value, showReimbursed);
            }
        }

        function printReport() {
            let expenses = JSON.parse(localStorage.getItem(getStorageKey('expenses')) || '[]');
            if (expenses.length === 0) {
                alert('No expenses to print!');
                return;
            }

            let html = '<h2>Daily Expense Report - Tudawe Trading</h2>';
            html += '<p>Date: ' + new Date().toLocaleDateString() + '</p>';
            html += '<table border="1" cellpadding="5">';
            html += '<tr><th>Date</th><th>Category</th><th>Description</th><th>Vendor</th><th>Amount</th></tr>';
            
            let total = 0;
            expenses.forEach(exp => {
                total += parseFloat(exp.amount);
                html += `<tr><td>${exp.date}</td><td>${exp.category}</td><td>${exp.description}</td><td>${exp.vendor || '-'}</td><td>Rs ${parseFloat(exp.amount).toFixed(2)}</td></tr>`;
            });
            html += `<tr><td colspan="4" style="text-align:right;"><b>Total:</b></td><td><b>Rs ${total.toFixed(2)}</b></td></tr>`;
            html += '</table>';

            const w = window.open('', '', 'height=500,width=900');
            w.document.write(html);
            w.document.close();
            w.print();
        }

        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const expense = {
                date: document.getElementById('expenseDate').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                vendor: document.getElementById('vendor').value,
                receipt: document.getElementById('receipt').value,
                reimbursed: false
            };

            let expenses = JSON.parse(localStorage.getItem(getStorageKey('expenses')) || '[]');
            expenses.push(expense);
            localStorage.setItem(getStorageKey('expenses'), JSON.stringify(expenses));

            // Show balance update alert
            const FLOAT_AMOUNT = 250000;
            const ious = JSON.parse(localStorage.getItem(getStorageKey('ious')) || '[]');
            const invoices = JSON.parse(localStorage.getItem(getStorageKey('invoices')) || '[]');
            const activeExpenses = expenses.filter(exp => !exp.reimbursed);
            const oldBalance = FLOAT_AMOUNT - (ious.reduce((sum, iou) => sum + parseFloat(iou.amount || 0), 0) + activeExpenses.slice(0, -1).reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0) - invoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0));
            const newBalance = FLOAT_AMOUNT - (ious.reduce((sum, iou) => sum + parseFloat(iou.amount || 0), 0) + activeExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0) - invoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0));
            const difference = oldBalance - newBalance;

            const alertDiv = document.getElementById('balanceAlert');
            const alertText = document.getElementById('balanceUpdateText');
            alertText.textContent = `New expense (Rs ${expense.amount.toFixed(2)}) added. Balance reduced by Rs ${difference.toFixed(2)}.`;
            alertDiv.classList.remove('hidden');
            
            // Hide alert after 5 seconds
            setTimeout(() => {
                alertDiv.classList.add('hidden');
            }, 5000);

            this.reset();
            initializeForm();
            displayExpenses();
            alert('Expense recorded successfully!');
        });

        document.getElementById('filterCategory').addEventListener('change', function() {
            const showReimbursed = document.getElementById('showReimbursedToggle')?.checked || false;
            displayExpenses(this.value, showReimbursed, document.getElementById('expenseSearch').value.trim());
        });

        document.getElementById('showReimbursedToggle')?.addEventListener('change', function() {
            displayExpenses(document.getElementById('filterCategory').value, this.checked, document.getElementById('expenseSearch').value.trim());
        });

        document.getElementById('expenseSearch').addEventListener('input', function() {
            displayExpenses(document.getElementById('filterCategory').value, document.getElementById('showReimbursedToggle')?.checked || false, this.value.trim());
        });

        // Bulk Import Handler
        document.getElementById('bulkImportForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const bulkData = document.getElementById('bulkData').value.trim();
            if (!bulkData) {
                alert('Please paste data to import');
                return;
            }

            const lines = bulkData.split('\n').filter(line => line.trim());
            let successCount = 0;
            let errorCount = 0;
            let expenses = JSON.parse(localStorage.getItem(getStorageKey('expenses')) || '[]');

            lines.forEach((line, index) => {
                try {
                    const parts = line.split(',').map(p => p.trim());
                    
                    if (parts.length < 5) {
                        console.warn(`Line ${index + 1}: Invalid format`);
                        errorCount++;
                        return;
                    }

                    const [dateStr, vendor, description, category, amountStr] = parts;
                    const amount = parseFloat(amountStr);

                    if (!dateStr || !vendor || !description || !category || isNaN(amount)) {
                        errorCount++;
                        return;
                    }

                    // Convert DD/MM/YYYY to YYYY-MM-DD
                    const dateParts = dateStr.split('/');
                    if (dateParts.length !== 3) {
                        errorCount++;
                        return;
                    }
                    const date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

                    const expense = {
                        date: date,
                        vendor: vendor,
                        description: description,
                        category: category,
                        amount: amount,
                        receipt: '',
                        reimbursed: false
                    };

                    expenses.push(expense);
                    successCount++;
                } catch (error) {
                    console.error(`Line ${index + 1} error:`, error);
                    errorCount++;
                }
            });

            if (successCount > 0) {
                // Sort by date descending
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem(getStorageKey('expenses'), JSON.stringify(expenses));
                displayExpenses();
            }

            let message = `‚úì Imported: ${successCount} Expenses`;
            if (errorCount > 0) {
                message += `\n‚ö†Ô∏è Errors: ${errorCount} lines`;
            }
            alert(message);

            if (successCount > 0) {
                document.getElementById('bulkData').value = '';
            }
        });

        // Initialize on load
        initializeForm();
        displayExpenses();
    </script>
</body>
</html>